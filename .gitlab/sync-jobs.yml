# .gitlab/sync-jobs.yml
# Contains the actual CI job definitions for the sync process

variables:
  # --- User Configuration ---
  # 请在 GitLab CI/CD 设置中配置这些变量
  # GITHUB_TOKEN: "YOUR_GITHUB_PAT" (具有 repo 读写和 PR 合并权限, Protected, Masked)
  # GITHUB_OWNER_REPO: "your_github_owner/your_github_repo" (例如: OpenSiFli/sync-pr-to-gitlab)
  # GITHUB_ACTOR: "your-github-username-or-bot" (用于 GitHub 提交的用户名)
  # GITLAB_PROJECT_PATH: "your_group/your_project" (例如: opensifli/sifli-sdk-new, Protected)
  # GITLAB_API_URL: "https://gitlab.com/api/v4" (或你的自托管实例 API 地址)
  # GITLAB_PIPELINE_TRIGGER_TOKEN: "YOUR_GITLAB_TRIGGER_TOKEN" (在 Settings > CI/CD > Pipeline triggers 创建)
  # GITLAB_API_TOKEN: "YOUR_GITLAB_API_TOKEN" (具有 API 访问权限, Protected, Masked)

  # --- Internal Variables ---
  GIT_STRATEGY: clone # 确保每次都全新克隆
  GIT_DEPTH: 0 # 克隆完整历史
  TARGET_BRANCH: main # 定义目标同步分支，方便修改

trigger_github_actions:
  stage: trigger_sync
  # 触发方式: manual (手动), schedule (定时), or on push to specific branches
  when: manual # 初始设置为手动触发，方便测试
  image: ubuntu:22.04 # 使用 Ubuntu 22.04 镜像
  before_script:
    # 更新 apt 包列表并安装必要的工具
    - apt-get update && apt-get install -y --no-install-recommends git curl jq ca-certificates
    - git config --global user.email "gitlab-ci@example.com" # 设置 Git 提交者信息
    - git config --global user.name "GitLab CI Sync Bot"
  script:
    - echo "=== Starting GitLab to GitHub Sync ==="
    - echo "Target Branch: ${TARGET_BRANCH}"
    # Check variables - combined block
    - |
      set -e
      echo "Checking required variables..."
      if [ -z "${GITHUB_TOKEN}" ] || [ -z "${GITHUB_OWNER_REPO}" ] || [ -z "${GITHUB_ACTOR}" ]; then
        echo "Error: Required GitHub variables (GITHUB_TOKEN, GITHUB_OWNER_REPO, GITHUB_ACTOR) are not set."
        exit 1
      fi
      # Check GitLab variables (using GITLAB_PROJECT_PATH now)
      if [ -z "${GITLAB_PROJECT_PATH}" ] || [ -z "${GITLAB_API_URL}" ] || [ -z "${GITLAB_PIPELINE_TRIGGER_TOKEN}" ] || [ -z "${GITLAB_API_TOKEN}" ]; then
        echo "Error: Required GitLab variables (GITLAB_PROJECT_PATH, GITLAB_API_URL, GITLAB_PIPELINE_TRIGGER_TOKEN, GITLAB_API_TOKEN) are not set."
        exit 1
      fi
      echo "All required variables are set."
    # Clone, add remote, push - combined block
    - |
      set -e
      echo "1. Cloning GitLab repository (${TARGET_BRANCH})..."
      git clone --branch ${TARGET_BRANCH} "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_REPOSITORY_URL#https://}" repo
      cd repo
      echo "2. Adding GitHub remote..."
      GITHUB_REPO_URL="github.com/${GITHUB_OWNER_REPO}.git"
      git remote add github "https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@${GITHUB_REPO_URL}"
      echo "3. Pushing GitLab ${TARGET_BRANCH} to GitHub ${TARGET_BRANCH}... (using --force)"
      git push github ${TARGET_BRANCH} --force
    # Trigger GitHub Actions - combined block
    - |
      set -e
      echo "4. Triggering GitHub Actions workflow (repository_dispatch)..."
      JSON_PAYLOAD=$(jq -n --arg pipeline_id "$CI_PIPELINE_ID" '{event_type: "start_pr_merge_sync", client_payload: {gitlab_pipeline_id: $pipeline_id}}')
      echo "Payload: $JSON_PAYLOAD"
      curl -f -X POST \
        -H "Accept: application/vnd.github.v3+json" \
        -H "Authorization: token ${GITHUB_TOKEN}" \
        "https://api.github.com/repos/${GITHUB_OWNER_REPO}/dispatches" \
        -d "$JSON_PAYLOAD"
    - echo "=== GitLab to GitHub Sync Triggered Successfully ==="
  artifacts:
    expire_in: 1 day # 保留作业日志

finalize_sync_from_github:
  stage: finalize_sync
  image: ubuntu:22.04 # 使用 Ubuntu 22.04 镜像
  rules:
    # 仅当流水线由触发器启动且包含 MERGE_RESULTS 变量时运行
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $MERGE_RESULTS'
  before_script:
    # 更新 apt 包列表并安装必要的工具 (add python3 for url encoding)
    - apt-get update && apt-get install -y --no-install-recommends git curl jq ca-certificates python3
    - git config --global user.email "gitlab-ci@example.com"
    - git config --global user.name "GitLab CI Sync Bot"
  script:
    - echo "=== Finalizing Sync from GitHub ==="
    - echo "Received merge results: $MERGE_RESULTS"
    # Parse results - combined block
    - |
      set -e
      SUCCESSFUL_PRS=$(echo "$MERGE_RESULTS" | jq -r '.successful_prs // [] | .[]')
      MERGE_ERROR=$(echo "$MERGE_RESULTS" | jq -r '.error // ""')

      if [ -n "$MERGE_ERROR" ]; then
        echo "Error reported from GitHub Actions during PR merge: $MERGE_ERROR"
        # Add notification logic here if needed
      fi
    # Clone, add remote, fetch, reset, push - combined block
    - |
      set -e
      echo "1. Cloning GitLab repository (${TARGET_BRANCH})..."
      git clone --branch ${TARGET_BRANCH} "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_REPOSITORY_URL#https://}" repo
      cd repo
      echo "2. Adding GitHub remote..."
      GITHUB_REPO_URL="github.com/${GITHUB_OWNER_REPO}.git"
      git remote add github "https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@${GITHUB_REPO_URL}"
      echo "3. Fetching latest ${TARGET_BRANCH} from GitHub..."
      git fetch github ${TARGET_BRANCH}
      echo "4. Resetting local ${TARGET_BRANCH} to GitHub's ${TARGET_BRANCH}... (using checkout -B)"
      git checkout -B ${TARGET_BRANCH} github/${TARGET_BRANCH}
      echo "5. Pushing updated ${TARGET_BRANCH} back to GitLab... (using --force)"
      git push origin ${TARGET_BRANCH} --force
    # Close MRs - combined block
    - |
      set -e
      echo "6. Closing corresponding GitLab MRs for successful PRs..."
      # Re-parse SUCCESSFUL_PRS as it's a new script block
      SUCCESSFUL_PRS=$(echo "$MERGE_RESULTS" | jq -r '.successful_prs // [] | .[]')

      if [ -z "$SUCCESSFUL_PRS" ]; then
        echo "No successful PRs reported by GitHub Actions."
      else
        # URL-encode the project path (requires python3)
        if ! command -v python3 &> /dev/null; then
            echo "Error: python3 is required for URL encoding but not found."
            exit 1
        fi
        ENCODED_PROJECT_PATH=$(python3 -c "import urllib.parse; print(urllib.parse.quote(input(), safe=''))" <<< "$GITLAB_PROJECT_PATH")

        MR_LIST_URL="${GITLAB_API_URL}/projects/${ENCODED_PROJECT_PATH}/merge_requests?state=opened&per_page=100"
        echo "Fetching open MRs from: ${MR_LIST_URL}"
        curl -fsSL --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" "${MR_LIST_URL}" > mrs.json
        if ! jq empty mrs.json > /dev/null 2>&1; then
           echo "Error: Failed to fetch or parse GitLab MRs. Response:"
           cat mrs.json
           exit 1 # Exit if MR fetch fails
        fi

        echo "$SUCCESSFUL_PRS" | while IFS= read -r pr_number; do
          echo "Processing successful GitHub PR #${pr_number}..."
          # Search description for the PR URL pattern
          GITHUB_PR_URL_PATTERN="github.com/${GITHUB_OWNER_REPO}/pull/${pr_number}"
          MR_IID=$(jq -e --arg pattern "$GITHUB_PR_URL_PATTERN" '.[] | select(.description | contains($pattern)) | .iid' mrs.json)

          if [ $? -eq 0 ] && [ -n "$MR_IID" ]; then
            echo "Found corresponding GitLab MR #${MR_IID} via description search. Closing..."
            CURRENT_DESC=$(jq -e --argjson iid "$MR_IID" '.[] | select(.iid == $iid) | .description' mrs.json)
            if [ $? -ne 0 ]; then
               echo "Warning: Could not retrieve description for MR #${MR_IID}. Skipping description update."
               CURRENT_DESC=""
            fi

            printf -v NEW_DESC "%s\n\n*Closed automatically: Corresponding GitHub PR #%s merged.*" "$CURRENT_DESC" "$pr_number"

            CLOSE_MR_URL="${GITLAB_API_URL}/projects/${ENCODED_PROJECT_PATH}/merge_requests/${MR_IID}"
            echo "Closing MR via URL: ${CLOSE_MR_URL}"
            curl -f --request PUT --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
              "${CLOSE_MR_URL}" \
              --data-urlencode "state_event=close" \
              --data-urlencode "description=${NEW_DESC}"
            echo # Add newline
            echo "  - Closed GitLab MR #${MR_IID}."
          else
            echo "Warning: Could not find corresponding open GitLab MR for successfully merged GitHub PR #${pr_number} via description search."
          fi
        done
      fi
    - echo "=== Sync from GitHub Finalized ==="
  artifacts:
    expire_in: 1 day
